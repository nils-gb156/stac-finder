const db = require('../db');
const path = require('path');

const getCollectionById = async (req, res) => {
    const { id } = req.params;

    try {
        // erweitern der Query, um die BBox-Koordinaten direkt aus der Geometrie zu ziehen
        const query = `
            SELECT *, 
                   ST_XMin(spatial_extent) as xmin, 
                   ST_YMin(spatial_extent) as ymin, 
                   ST_XMax(spatial_extent) as xmax, 
                   ST_YMax(spatial_extent) as ymax 
            FROM stac.collections 
            WHERE id = $1
        `;

        const result = await db.query(query, [id]);

        if (result.rows.length === 0) {
            return res.status(404).json({
                error: 'Collection not found',
                message: `No collection with id "${id}" found`
            });
        }

        const row = result.rows[0]; 

        const collection = {
            stac_version: '1.0.0',
            type: 'Collection',
            id: row.id.toString(),
            title: row.title,
            description: row.description,
            extent: {
                spatial: {
                    // BBox aus den berechneten Koordinaten zusammensetzen
                    bbox: [[row.xmin, row.ymin, row.xmax, row.ymax]]
                },
                temporal: {
                    interval: [[row.temporal_start, row.temporal_end]]
                }
            },
            license: row.license,
            keywords: row.keywords,
            providers: row.providers?.map(name => ({ name })),
            
            summaries: {
                doi: row.doi,
                platform: row.platform_summary,
                constellation: row.constellation_summary,
                gsd: row.gsd_summary,
                'processing:level': row.processing_level_summary
            },

            links: [
                {
                    rel: 'self',
                    href: `/collections/${row.id}`,
                    type: 'application/json'
                },
                {
                    rel: 'root',
                    href: '/',
                    type: 'application/json'
                },
                {
                    rel: 'parent',
                    href: '/collections',
                    type: 'application/json'
                }
            ]
        };

        
        res.json(collection);

    } catch (err) {
        console.error('Error fetching collection by id: ', err);
        res.status(500).json({ error: 'Internal server error' });
    }
};

module.exports = { getCollectionById };