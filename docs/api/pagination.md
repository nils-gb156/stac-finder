# STAC-Compliant Pagination

## Overview

The API supports STAC-compliant pagination for the `/collections` endpoint. The implementation follows OGC API - Features pagination patterns and uses opaque tokens to navigate through large result sets efficiently without exposing internal database offsets.

## Query Parameters

### `limit`

Controls the maximum number of items returned in a single response.

**Format:** Positive integer

**Constraints:**
- **Minimum**: 1
- **Maximum**: 10000
- **Default**: 10

**Behavior:**
- If not specified, returns 10 items (default)
- If specified value exceeds maximum, it's automatically capped at 10000
- Invalid values (negative, zero, non-numeric) return an error

### `token`

Opaque pagination token for navigating to specific pages in the result set.

**Format:** Base64-encoded string (automatically generated by the API)

**Usage:**
- Do not construct tokens manually
- Use the `next` and `prev` link URLs provided in the response
- Tokens encode the offset position in the result set
- Tokens are independent of other query parameters

## Pagination Flow

### Initial Request
Make a request without a token to get the first page:

```
GET /collections?limit=20
```

### Response Structure
The API returns a response with `links` array containing pagination links:

```json
{
  "collections": [...],
  "links": [
    {
      "rel": "self",
      "href": "/collections?limit=20",
      "type": "application/json"
    },
    {
      "rel": "next",
      "href": "/collections?limit=20&token=xyz",
      "type": "application/json"
    }
  ]
}
```

### Navigation
- **Next page**: Follow the `rel: "next"` link if present
- **Previous page**: Follow the `rel: "prev"` link if present
- **Current page**: The `rel: "self"` link always points to the current request

### Link Presence Rules
- **`next` link**: Present only if there are more results available (full page was returned)
- **`prev` link**: Present only if not on the first page (offset > 0)
- **`self` link**: Always present

## Examples

### Example 1: Get first page with default limit
```bash
curl "/collections"
```
Returns the first 10 collections (default limit).

### Example 2: Get first page with custom limit
```bash
curl "/collections?limit=50"
```
Returns the first 50 collections.

### Example 3: Navigate to next page
```bash
# First request
curl "/collections?limit=20"

# Use the 'next' link from the response
curl "/collections?limit=20&token=xyz"
```
Returns items 21-40.

### Example 4: Combine with sorting
```bash
curl "/collections?sortby=title&limit=25"
```
Returns the first 25 collections sorted by title. The `next` link preserves the sort order.

### Example 5: Combine with filtering
```bash
curl "/collections?datetime=2020-01-01/..&q=sentinel&limit=15"
```
Returns the first 15 Sentinel collections from 2020 onwards. Pagination links preserve all filters.

### Example 6: Maximum limit
```bash
curl "/collections?limit=10000"
```
Returns up to 10.000 collections in a single response (maximum allowed).

## Token Mechanics

### Token Structure
Tokens are Base64-encoded JSON objects:
```javascript
// Token content (before encoding)
{ "offset": 20 }

// Encoded token
"xyz"
```

### Token Behavior
- **Opaque**: Clients should treat tokens as opaque strings
- **Temporary**: Tokens may expire or become invalid if the underlying data changes
- **Stateless**: Tokens contain all information needed to fetch the page (no server-side session)
- **Query-independent**: The same token works regardless of filter/sort parameters in the URL

### Token Validation
The API validates tokens and returns errors for:
- Malformed Base64 encoding
- Invalid JSON structure
- Corrupted or tampered data

## Error Handling

The API returns detailed error messages for invalid pagination parameters:

### Invalid Limit
```json
{
  "error": "Invalid limit parameter",
  "message": "limit must be a positive integer"
}
```

**Common causes:**
- Negative numbers: `limit=-10`
- Zero: `limit=0`
- Non-numeric values: `limit=abc`

### Invalid Token
```json
{
  "error": "Invalid token parameter",
  "message": "token is malformed or invalid"
}
```

**Common causes:**
- Manually constructed or modified tokens
- Corrupted Base64 encoding
- Invalid JSON structure within token
- Tokens from a different API version or instance

## Implementation Details

### Offset-Based Pagination
The implementation uses offset-based pagination internally:
```sql
SELECT * FROM collections LIMIT 20 OFFSET 40
```

This fetches 20 items starting from the 41st item (offset 40).

### Token Generation
The `createPaginationToken()` function in [pagination.js](../../api/utils/pagination.js) generates tokens by:
1. Creating a JSON object with the offset: `{ "offset": 20 }`
2. Encoding it as Base64: `Buffer.from(JSON.stringify({offset})).toString('base64')`

### Link Generation
The `createPaginationLinks()` function builds STAC-compliant link objects:
- Preserves all original query parameters (filters, sorting)
- Adds/updates the `token` parameter for next/prev links
- Includes the `limit` parameter in all pagination links
- Constructs proper query strings with URL encoding

### Query Parameter Preservation
When navigating between pages, all query parameters are preserved:
```
Original: /collections?sortby=title&datetime=2020-01-01/..&limit=20
Next:     /collections?sortby=title&datetime=2020-01-01/..&limit=20&token=xyz
```

### Performance Considerations
- **Limit cap**: Maximum limit of 10,000 prevents excessive memory usage
- **Index usage**: Database queries benefit from indexes on sorted columns
- **Token size**: Tokens are small (~20-30 bytes encoded) for efficient transmission

## STAC Conformance

This implementation follows STAC API and OGC API specifications:
- `limit` parameter for controlling page size
- Opaque pagination tokens (vs. exposing raw offsets)
- `self`, `next`, and `prev` link relations
- Query parameter preservation across pages
- Standard STAC link object format (`rel`, `href`, `type`)
- Compatible with filtering and sorting parameters
- Graceful handling of last page (no `next` link)

## Tests

Unit tests for pagination can be found in [pagination.test.js](../../api/tests/unit/pagination.test.js).

To run the tests:
```bash
cd api
npm test -- tests/unit/pagination.test.js
```

The tests cover:
- Default limit behavior
- Custom limit values
- Limit validation (negative, zero, non-numeric)
- Maximum limit capping
- Token encoding and decoding
- Link generation logic
- Next/prev link presence conditions
- Query parameter preservation
- Invalid token handling

## Best Practices

### For API Clients
1. **Always use provided links**: Don't construct pagination URLs manually
2. **Follow `next` links**: Keep fetching until no `next` link is present
3. **Handle missing links**: Check for `next`/`prev` existence before following
4. **Set appropriate limits**: Balance between network overhead and response time
5. **Cache responses**: Consider caching pages if data doesn't change frequently

### For API Consumers
1. **Start small**: Use smaller limits (20-50) for interactive applications
2. **Batch processing**: Use larger limits (1000-10000) for batch data export
3. **Error handling**: Implement retry logic for token validation errors
4. **Timeout handling**: Larger limits may take longer to process
